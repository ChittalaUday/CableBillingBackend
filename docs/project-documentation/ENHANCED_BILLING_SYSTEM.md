# Enhanced Billing System

This document describes the enhancements made to the Cable Management System's billing functionality.

## Overview

The billing system has been significantly enhanced to provide better financial tracking, audit trails, and integration with box activation features. All financial operations now leave proper trails and are tied back to the staff who performed them.

## Key Enhancements

### 1. Bills

**Removed Fields:**
- `previousReading`
- `currentReading`
- `unitsConsumed`

**Added Fields:**
- `generatedBy`: Staff member who generated the bill
- `isPhysicalBillGenerated`: Boolean indicating if a physical receipt was generated

### 2. Payments

**Added Fields:**
- `paymentSource`: Source of payment (CASH, ONLINE, CHEQUE, etc.)
- `collectedBy`: Staff member who collected the payment (optional)
- `isReceiptGenerated`: Boolean indicating if a physical receipt was generated

### 3. Transactions

**Enhanced Functionality:**
- Centralized ledger for all money-related activities
- Links to Bills, Payments, DueSettlements, and BoxActivations
- `transactionType` values: BILL_GENERATED, PAYMENT_RECEIVED, DUE_SETTLED, BOX_ACTIVATED, etc.
- `performedBy`: Staff member who executed the action (null if system/online)
- `relatedBillId`: Optional link to Bill
- `relatedPaymentId`: Optional link to Payment
- `relatedDueSettlementId`: Optional link to DueSettlement
- `relatedActionId`: Optional link to BoxActivation

### 4. Due Settlements

**Added Fields:**
- `settledBy`: Staff member who settled the due

### 5. Users

**Added Relations:**
- `generatedBills`: Bills generated by this user
- `collectedPayments`: Payments collected by this user
- `settledDues`: Due settlements processed by this user
- `serviceActions`: Box activation actions performed by this user
- `performedTransactions`: Transactions performed by this user

### 6. Box Activation Features

A completely new feature set for tracking set-top box status changes:
- New `BoxActivation` model
- Enhanced `Customer` model with box status tracking fields
- Automatic transaction generation for all box actions

## Database Schema Changes

### Updated Models

#### User
```prisma
model User {
  // ... existing fields ...
  
  // New relations
  generatedBills    Bill[]      @relation("BillGeneratedBy")
  collectedPayments Payment[]   @relation("PaymentCollectedBy")
  settledDues       DueSettlement[] @relation("DueSettlementSettledBy")
  serviceActions    BoxActivation[] @relation("ServiceActionPerformedBy")
  performedTransactions Transaction[] @relation("TransactionPerformedBy")
}
```

#### Customer
```prisma
model Customer {
  // ... existing fields ...
  
  // New box status tracking fields
  boxStatus             String?   @default("INACTIVE")
  boxActivatedAt        DateTime?
  lastBoxStatusChangedAt DateTime?
  
  // New relation
  serviceActions BoxActivation[] @relation("CustomerServiceActions")
}
```

#### Bill
```prisma
model Bill {
  // ... existing fields ...
  
  // Removed fields
  // previousReading    Int
  // currentReading     Int
  // unitsConsumed      Int
  
  // Added fields
  generatedBy           String    // Staff who generated the bill
  isPhysicalBillGenerated Boolean @default(false) // Physical receipt generated
  
  // New relations
  generator      User  @relation("BillGeneratedBy", fields: [generatedBy], references: [id])
  transactions   Transaction[] @relation("TransactionBill")
}
```

#### Payment
```prisma
model Payment {
  // ... existing fields ...
  
  // Added fields
  paymentSource      String   // "CASH", "ONLINE", "CHEQUE", etc.
  collectedBy        String?  // Staff who collected payment
  isReceiptGenerated Boolean  @default(false) // Physical receipt generated
  transactionId      String?  @unique
  
  // Updated relations
  collector   User?    @relation("PaymentCollectedBy", fields: [collectedBy], references: [id])
  transaction Transaction? @relation("TransactionPayment")
}
```

#### DueSettlement
```prisma
model DueSettlement {
  // ... existing fields ...
  
  // Added fields
  settledBy       String   // Staff who settled the due
  
  // Updated relations
  settler  User  @relation("DueSettlementSettledBy", fields: [settledBy], references: [id])
  transactions Transaction[] @relation("TransactionDueSettlement")
}
```

#### Transaction
```prisma
model Transaction {
  // ... existing fields ...
  
  // Added fields
  performedBy       String?  // Staff who executed action; null if system/online
  
  // Optional relations to other entities
  relatedBillId     String?
  relatedPaymentId  String?  @unique
  relatedDueSettlementId String?  @unique
  relatedActionId   String?  @unique

  // Updated relations
  performer      User?  @relation("TransactionPerformedBy", fields: [performedBy], references: [id])
  relatedBill    Bill?  @relation("TransactionBill", fields: [relatedBillId], references: [id])
  relatedPayment Payment?  @relation("TransactionPayment", fields: [relatedPaymentId], references: [id])
  relatedDueSettlement DueSettlement? @relation("TransactionDueSettlement", fields: [relatedDueSettlementId], references: [id])
  relatedAction  BoxActivation? @relation("TransactionServiceAction", fields: [relatedActionId], references: [id])
}
```

#### BoxActivation (New Model)
```prisma
model BoxActivation {
  id          String   @id @default(cuid())
  customerId  String
  actionType  String   // "ACTIVATED", "SUSPENDED", "DEACTIVATED", "REACTIVATED"
  actionDate  DateTime @default(now())
  performedBy String?  // Staff who performed action; null if automated/system
  reason      String?  // Reason for action e.g., "New Connection", "Due Payment", "Complaint Resolved"
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  transactionId String? @unique

  // Relations
  customer   Customer @relation("CustomerServiceActions", fields: [customerId], references: [id])
  performer  User?    @relation("ServiceActionPerformedBy", fields: [performedBy], references: [id])
  transaction Transaction? @relation("TransactionServiceAction")

  @@map("box_activations")
}
```

## API Endpoints

### Box Activation Module
- `POST /api/box` - Create a new box activation
- `GET /api/box/customer/:customerId` - Get all box activations for a customer
- `GET /api/box/:id` - Get box activation by ID

### Enhanced Customer Module
- Customer model now includes box status tracking fields

## Implementation Details

### 1. Data Consistency
All operations are performed within database transactions to ensure data consistency across related entities.

### 2. Automatic Updates
- Customer box status fields are automatically updated when box activations are created
- Transaction records are automatically generated for all financial and box actions

### 3. Audit Trail
Every action leaves a traceable record:
- Who performed the action
- When it was performed
- What the action was
- Related entities

### 4. Authorization
Role-based access control ensures only authorized personnel can perform actions:
- Creating box activations requires STAFF or higher permissions
- Viewing box activations can be done by staff or the customer themselves
- Viewing specific box activations by ID requires STAFF or higher permissions

## Benefits

1. **Complete Audit Trail**: Every financial and service action is tracked with full context
2. **Enhanced Accountability**: All actions are tied to specific staff members
3. **Improved Reporting**: Better data for financial and operational reporting
4. **Regulatory Compliance**: Enhanced tracking helps meet regulatory requirements
5. **Operational Efficiency**: Streamlined processes for common billing and service operations
6. **Customer Service**: Better visibility into customer service history

## Future Enhancements

1. Integration with payment gateways for online payments
2. Automated billing and payment processing
3. Advanced reporting and analytics
4. Integration with CRM systems
5. Mobile app for field staff
6. Customer self-service portal